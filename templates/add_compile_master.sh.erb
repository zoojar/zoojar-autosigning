#!/bin/bash
# Adds a new compile master (already specified in dns_alt_names), requires the agent on the new compiler to run 3 times within 10 minutes

log_file='/var/log/puppetlabs/puppetserver/add_compile_master.log'
certname=$1
max_attempts=60
retry_interval=10

PATH="/opt/puppetlabs/bin:/opt/puppetlabs/puppet/bin:/opt/puppet/bin:$PATH"

declare -x PE_CERT=$(puppet agent --configprint hostcert)
declare -x PE_KEY=$(puppet agent --configprint hostprivkey)
declare -x PE_CA=$(puppet agent --configprint localcacert)
declare -x PE_CERTNAME=$(puppet agent --configprint certname)
declare -x NC_CURL_OPT="-s --cacert $PE_CA --cert $PE_CERT --key $PE_KEY --insecure"

group_id()
{
  echo $(curl $NC_CURL_OPT https://localhost:4433/classifier-api/v1/groups | python -m json.tool | grep -C 2 "$1" | grep "id" | cut -d: -f2 | sed 's/[\", ]//g')
}

echo -e "\n$(date) INFO: Signing a new compile master: $certname." >> $log_file
puppet cert --allow-dns-alt-names sign $certname

echo -e "\n$(date) INFO: Waiting for 1st report from node $certname." >> $log_file 
retry_count=0
until [ "$report_response" == "Applied catalog" || "$retry_count" -gt "$max_attempts" ]; do
  report_response="$(curl -X GET http://localhost:8080/pdb/query/v4/reports -d "query=[\"=\", \"certname\", \"$certname\"]\' -d \'order_by=[{\"field\": \"receive_time\", \"order\": \"desc\"}]" -d 'limit=1' | grep 'Applied catalog' -Po)"
  (( retry_count++ ))
  sleep $retry_interval
done
if [ "$retry_count" -ge "$max_attempts" ]; then
  echo -e "\n$(date) FAIL: Timed out waiting for 1st report from node $certname, aborting." >> $log_file 
  exit 1
fi

echo -e "\n$(date) INFO: Classifying $certname as a new compiler." >> $log_file
curl -X POST -H 'Content-Type: application/json' -d "{\"nodes\": [\"baz.tld\"]}" "https://localhost:4433/classifier-api/v1/groups/$(group_id 'PE Master')/pin"

echo -e "\n$(date) INFO: Waiting for report from node $certname containing 'pe_master'." >> $log_file
retry_count=0
until [ "$report_response" == "Applied catalog" || "$retry_count" -gt "$max_attempts" ]; do
  report_response="$(curl -X GET http://localhost:8080/pdb/query/v4/reports -d "query=[\"=\", \"certname\", \"$certname\"]\' -d \'order_by=[{\"field\": \"receive_time\", \"order\": \"desc\"}]" -d 'limit=1' | grep 'Applied catalog <pe_master>' -Po)"
  (( retry_count++ ))
  sleep $retry_interval
done
if [ "$retry_count" -ge "$max_attempts" ]; then
  echo -e "\n$(date) FAIL: Timed out waiting for pe_master report from node $certname, aborting." >> $log_file 
  exit 1
fi

echo -e "\n$(date) INFO: Running 'puppet agent -t' on this MOM." >> $log_file
#<Fork this and exit...>
exit 0